<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="data:image/x-icon">
    <title>Красная армия</title>
</head>
<style>
    /* main */
    :root {
        --otmuchka: #dadada;
        --novice: #00cc00;
        --stalker: #006ce7;
        --veteran: #aa00aa;
        --master: #ff5555;
        --legenda: #c5a114;
        --dark-grey: rgb(73, 73, 73);
        --scrollbar-bg: #bfbfbf;
        --grey: rgb(221, 221, 221);
        --red: rgb(255, 57, 57);
    }
    body {
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        overflow-y: auto;
        overflow-x: hidden;
        flex-direction: column;
    }
    /* elements */
    .title {
        font-size: 32px;
        font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-weight: 800;
        line-height: 5px;
    }
    .description {
        font-size: 17px;
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
        font-weight: 500;
    }
    .question {
        font-size: 20px;
        font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
        font-weight: 800;
    }
    .styled-img {
        margin-bottom: 20px;
        pointer-events: none;
        user-select: none;
    }
    .styled-input {
        user-select: none;
        appearance: none;
        border:none;
        border-bottom: solid 1px var(--grey);
        outline: none;
        padding-bottom: 10px;
        height: 20px;
        margin-bottom: 20px;
        font-size: 16px;
        transition: 200ms border-bottom;
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }
    .upgrade-input {
        width:200px
    }
    .str-input {
        width: 300px;
    }
    .styled-input:focus {
        border-bottom: solid 1px var(--red);
    }
    .styled-btn {
        user-select: none;
        height: 30px;
        color:red;
        border: solid 1px var(--grey);
        border-radius: 5px;
        box-shadow: 1px 1px 3px 0 black;
        cursor: pointer;
        transition: 200ms;
    }
    .styled-btn:hover {
        text-shadow: 1px 1px 2px var(--red);
    }
    .next-btn, .before-btn {
        width: 100px;
    }
    .restart-btn {
        width: 140px;
    }
    .progress-bar {
        user-select: none;
        width: 200px;
        height: 12px;
        background-color: var(--dark-grey);
    }
    .progress-bar_before {
        margin-left:246px;
        position: absolute;
        width: 200px;
        height: 12px;
        background-color: var(--red);
    }
    .combobox {
        font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
        height: 10px;
    }
    .combobox-input {
        font-size: 15px;
        font-weight: 200;
        outline: none;
        border: 1px solid var(--grey);
        width: 240px;
        display: flex;
        margin: 0;
        height: 30px;
        align-items: center;
        padding: 0 5px;
    }
    .item-list_box {
        height: 100px;
        z-index: 1;
        user-select: none;
        overflow-x: hidden;
        overflow-y: auto;
        width: 250px;
        position: absolute;
    }
    .item-list {
        width: 250px;
        display: block;
        list-style: none;
        padding: 0;
        margin: 0;
        background-color: white;
        border-left: solid 1px var(--grey);
    }
    .item-list_box::-webkit-scrollbar {
        appearance: none;
        width: 6px;
        
    }
    .item-list_box::-webkit-scrollbar-thumb {
        background-color: var(--dark-grey);
    }
    .item-list_box::-webkit-scrollbar-track {
        background-color: var(--scrollbar-bg);
    }
    
    .item-list li {
        user-select: none;
        height: 20px;
        padding: 5px;
    }
    .item-list li:hover {
        cursor: pointer;
        opacity: 0.8
    }

    .add-weapon-btn, .add-armor-btn {
        width: 100px;
    }

    /* blocks */
    .header {
        margin-top: 30px;
        border-radius: 5px;
        border-top: 9px solid var(--red);
        height: 140px;
        margin-bottom: 50px;
    }
    
    .body {
        display: grid;
        gap:10px;
        margin-bottom: 20px;
    }

    .footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 700px;
    }

    .selector {
        display: block;
        width: 700px;
        border-radius: 5px;
        border: 1px solid var(--grey);
        margin-bottom: 10px;
        border-radius: 10px;
    }

    .block {

        padding: 0px 20px 0 20px;

        display: grid;
    }
    .pre-block {
        display: flex;
        justify-content: space-between;
    }
    .box {
        width: 210px;
        display: flex;
        justify-content: space-between;
    }
    .cart {
        background-color: white;
        overflow-x: hidden;
        overflow-y: auto;
        width: 340px;
        height: 60px;
        border: solid 1px var(--grey);
        list-style: none;
        padding: 0 5px;
        margin-bottom: 30px;
        display: block;
    }
    .remove-btn {
        user-select: none;
        position: relative;
        right: 10px;
        width: 10px;
        cursor: pointer;
        height: 17px;
        color: black;
    }
    .remove-btn::after {
        position: absolute;
        transform: rotate(-45deg);
        content: "|";
        margin-left:-1px;
        font-size: 15px;
    }
    .remove-btn::before {
        position: absolute;
        transform: rotate(45deg);
        content: "|";
        font-size: 15px;

    }
    .cart li {
        padding: 6px;
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }
    .cart::-webkit-scrollbar {
        appearance: none;
        width: 6px;
        
    }
    .cart::-webkit-scrollbar-thumb {
        background-color: var(--dark-grey);
    }
    .cart::-webkit-scrollbar-track {
        background-color: var(--scrollbar-bg);
    }

    .box-2 {
        align-items: center;
        display: flex;
        justify-content: space-between;
    }

    /* options */
    .red {
        color: var(--red);
    }
    .line {
        border-bottom: solid 1px var(--grey);
    }
    .color2 {
        color: var(--red);
        font-weight: 400;
        font-size: 14px;
    }
    .hidden {
        display: none;
    }

    .error {
        border: 1px solid var(--red);
    }

    .disabled:hover {
        cursor:no-drop;
        text-shadow: none;
    }
    .light {transition: 300ms;}
    .light[data-rang="0"] {box-shadow: 0px 0px 3px 2px var(--otmuchka)}
    .light[data-rang="1"] {box-shadow: 0px 0px 3px 2px var(--novice)}
    .light[data-rang="2"] {box-shadow: 0px 0px 3px 2px var(--stalker)}
    .light[data-rang="3"] {box-shadow: 0px 0px 3px 2px var(--veteran)}
    .light[data-rang="4"] {box-shadow: 0px 0px 3px 2px var(--master)}
    .light[data-rang="5"] {box-shadow: 0px 0px 3px 2px var(--legenda)}

    .item-list li[data-rang="0"] {background-color:var(--otmuchka)}
    .item-list li[data-rang="1"] {background-color:var(--novice)}
    .item-list li[data-rang="2"] {background-color:var(--stalker)}
    .item-list li[data-rang="3"] {background-color:var(--veteran)}
    .item-list li[data-rang="4"] {background-color:var(--master)}
    .item-list li[data-rang="5"] {background-color:var(--legenda)}
</style>
<body>
    <div class="header">
        <div class="selector">
            <div class="block line">
                <h2 class="title">Красная армия</h2>
                <h2 class="description">Заполните форму</h3>
            </div>
            <div class="block">
                <h2 class="description red">*Обязательный вопрос</h3>
            </div>
        </div>
    </div>
    <div class="body">
        <div class="selector" data-level="1">
            <div class="block">
                <h2 class="question">Ник в игре<span class="color2"> *</span></h2>
                <input data-name="namePers" type="text" class="str-input styled-input" placeholder="Мой ответ">
            </div>
        </div>
        <div class="selector" data-level="1">
            <div class="block">
                <h2 class="question">Ник в дискорде (ID)<span class="color2"> *</span></h2>
                <div class="img"></div>
                <input data-name="nameDS" type="text" class="str-input styled-input" placeholder="Мой ответ">
            </div>
        </div>
        <div class="selector" data-level="1">
            <div class="block block-3">
                <h2 class="question">Имя<span class="color2"> *</span></h2>
                <input data-name="name" type="text" class="str-input styled-input" placeholder="Мой ответ">
            </div>
        </div>
        <div class="selector" data-level="2">
            <div class="block">
                <h2 class="question">Основное оружие<span class="color2"> *</span></h2>
                <h2 class="description">(Можно написать несколько вариантов)</h2>
                <div class="pre-block">
                    <div class="weapon-list combobox">
                        <input class="combobox-input" placeholder="Выберите из списка">
                        <div class="item-list_box hidden">
                            <ul class="item-list weapons">
                                <!--  generate() js -->
                            </ul>
                        </div>
                    </div>
                    <input class="upgrade-input styled-input" placeholder="Заточка (0 - 15)" type="number">
                    <button class="add-weapon-btn styled-btn disabled">Добавить</button>
                </div>
                <div class="cart">
                    <!-- genCart() js -->
                </div>
            </div>
        </div>
        <div class="selector" data-level="2">
            <div class="block">
                <h2 class="question">Основная броня<span class="color2"> *</span></h2>
                <h2 class="description">(Можно написать несколько вариантов)</h2>
                <div class="pre-block">
                    <div class="armor-list combobox">
                        <input class="combobox-input" placeholder="Выберите из списка">
                        <div class="item-list_box  hidden">
                            <ul class="item-list armor">
                                <!--  generate() js -->
                            </ul>
                        </div>
                    </div>
                    <input class="upgrade-input styled-input" placeholder="Заточка (0 - 15)" type="number">
                    <button class="add-armor-btn styled-btn disabled">Добавить</button>
                </div>
                <div class="cart">
                    <!-- genCart() js -->
                </div>
            </div>
        </div>
        <div class="selector" data-level="3">
            <div class="block">
                <h2 class="question">Живучесть в сборке<span class="color2"> *</span></h2>
                <input data-name="hp" class="property-input styled-input" placeholder="Ваш ответ" type="number">
            </div>
        </div>
        <div class="selector" data-level="3">
            <div class="block">
                <h2 class="question">Пулестойкость в сборке<span class="color2"> *</span></h2>
                <input data-name="bulletRes" class="property-input styled-input" placeholder="Ваш ответ" type="number">
            </div>
        </div>
        <div class="selector" data-level="3">
            <div class="block">
                <h2 class="question">Эффективность лечения в сборке<span class="color2"> *</span></h2>
                <input data-name="powerRegen" class="property-input styled-input" placeholder="Ваш ответ" type="number">
            </div>
        </div>
        <div class="selector" data-level="3">
            <div class="block">
                <h2 class="question">Скорость в сборке<span class="color2"> *</span></h2>
                <input data-name="speed" class="property-input styled-input" placeholder="Ваш ответ" type="number">
            </div>
        </div>
        <div class="selector" data-level="4">
            <div class="block block-1">
                <h2 class="question">Данные записаны</h2>
                <h2 class="description">Удачной игры!</h3>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="box">
            <button class="before-btn styled-btn hidden">Назад</button>
            <button class="next-btn styled-btn">Далее</button>
        </div>
        <div class="progress-bar"></div><div class="progress-bar_before"></div><span class="description">Страница 1 из 3</span>
        
        <button class="restart-btn styled-btn">Очистить форму</button>
    </div>
</body>
<script defer>
    //variables
    var level = localStorage.getItem("cockie") ? 4 : 1;var active = false;var role = "next"; var data, maxLevels;
    const textInputs = {
        elements: [],
        level: []
    };

    if (level == 4) document.querySelector(".footer").classList.add("hidden");

    const guide = document.createElement("img");
    const img = document.querySelector(".img")
    const nextBtn = document.querySelector(".next-btn");
    const beforeBtn = document.querySelector(".before-btn");
    const selectors = document.querySelectorAll(".selector");
    const input1 = document.createElement("input");
    const block2 = document.querySelector(".block-2");
    const bar = document.querySelector(".progress-bar_before");
    const upgradeInputs = document.querySelectorAll(".upgrade-input");
    const barDescr = document.querySelector(".footer").querySelector(".description");
    const favicon = document.createElement("link");
    const wpnList = document.querySelector(".weapons");
    const armorList = document.querySelector(".armor");
    const comboBoxesI = document.querySelectorAll(".combobox-input");
    const itemLists = document.querySelectorAll(".item-list");
    const itemListBoxes = document.querySelectorAll(".item-list_box")
    const restartBtn = document.querySelector(".restart-btn");
    const addArmorBtn = document.querySelector(".add-armor-btn");
    const addWeaponBtn = document.querySelector(".add-weapon-btn");
    const inputs = document.querySelectorAll("input")
    const carts = document.querySelectorAll(".cart");
    const propInputs = document.querySelectorAll(".property-input");
    
    //options
    selectors.forEach(selector => {
        const res = [];
        res.push(+selector.dataset["level"]);
        res.sort((a,b)=> a-b);
        maxLevels = res[res.length-1]
    })
    
    inputs.forEach(input=> {
        if (input.className != "combobox-input" && Array.from(input.classList).indexOf("upgrade-input") == -1) {
            textInputs.elements.push(input)
            textInputs.level.push(input.closest(".selector").dataset["level"])
        }
    });

    (async()=> {
        const imgs = await fetch("/images").then(data=>data.json())
        data = await fetch("/db").then(data=>data.json())

        guide.src = `data:image/png;base64, ${imgs["guide-1"]}`
        guide.className = "styled-img"

        favicon.rel = "shortcut icon"
        favicon.href = `data:image/png;base64, ${imgs["favicon"]}`

        document.querySelector("head").append(favicon);img.append(guide);
        generate();
    })()
    

    const FORM = {
        inputs: [],
        weapons: [],
        armor: []
    }

    //functions
    const reverseText = (text) => {
            const letters = { //en - ru
                "a": "а","b": "в","c": "с","e": "е","k": "к","m": "м","o": "о","p": "р","t": "т","x": "х","y": "у","а": "a","в": "b","с": "c","е": "e","к": "k","м": "m","о": "o","р": "p","т": "t","х": "x","у": "y"
            }
            const a = []
            Array.from(text).forEach(letter => {
                a.push(letters[letter] ? letters[letter] : letter)
            })
            return a.join("")
        }

    const reload = () => {
        FORM.inputs = []
        textInputs.elements.forEach(input=> {
            FORM.inputs.push({value:input.value, name:input.dataset["name"]})
        })
        selectors.forEach(selector=> {
            selector.style.display = +selector.dataset["level"] != level ? "none" : "block"
            if (!selector.dataset["level"]) selector.style.display = "block"
        })
        if (level > 1) {
            beforeBtn.classList.remove("hidden")
        } else {
            beforeBtn.classList.add("hidden")
        }
        if (level >= maxLevels - 1) {
            nextBtn.textContent = "Отправить"
            role = "submit"
        } else {
            nextBtn.textContent = "Далее"
            role = "next"
        }
        bar.style = `width: ${Math.round(200/(maxLevels-level))}px;`
        barDescr.textContent = level + " из " + (+maxLevels-1);
        if (active) {
            if (active == comboBoxesI[0]) { //weapons
                itemListBoxes[0].classList.remove("hidden");
                itemListBoxes[1].classList.add("hidden");
            } else { //armor
                itemListBoxes[1].classList.remove("hidden");
                itemListBoxes[0].classList.add("hidden");
            }
        } else {
            itemListBoxes[0].classList.add("hidden");
            itemListBoxes[1].classList.add("hidden");
        }
        
        upgradeInputs.forEach(input=> {
            if (input.value < 0) input.value = 0
            if (input.value > 15) input.value = 15
        })

        if (upgradeInputs[0].value != "" && comboBoxesI[0].placeholder != "Выберите из списка") {
            addWeaponBtn.classList.remove("disabled")
        } else {
            addArmorBtn.classList.add("disabled")
        }

        if (upgradeInputs[1].value != "" && comboBoxesI[1].placeholder != "Выберите из списка") {
            addArmorBtn.classList.remove("disabled")
        } else {
            addArmorBtn.classList.add("disabled")
        }

        if (FORM.weapons.length == 0) {
            carts[0].classList.add("hidden");
        } else {
            carts[0].classList.remove("hidden");
        }
        if (FORM.armor.length == 0) {
            carts[1].classList.add("hidden");
        } else {
            carts[1].classList.remove("hidden");
        }
    }
    const genCart = (cart) => {
        carts[cart].innerHTML = "";
        const formObj = (cart == 0 ? FORM.weapons : FORM.armor)
        formObj.forEach((data, index)=> {
                const container = document.createElement("div");
                container.className = "box-2";
                const closeBtn = document.createElement("div");
                closeBtn.className = "remove-btn";
                closeBtn.onclick = () => {
                    formObj.splice(index, 1)
                    genCart(cart)
                }
                const li = document.createElement("li");
                li.textContent = Math.round(data.mod) == 0 ? data.name : `${data.name} | +${Math.round(data.mod)}`;
                container.append(li);
                container.append(closeBtn);
                carts[cart].append(container);
        })
    }

    const generate = (opt) => {
        itemLists[0].innerHTML = ""; itemLists[1].innerHTML = "";
        (opt ? [""] : ["weapons", "armor"]).forEach((type, index) => {
            (opt ? opt.data : data[type]).sort((a,b)=> a.rang-b.rang);
            (opt ? opt.data : data[type]).forEach(obj => {
                const li = document.createElement("li")
                li.dataset["rang"] = obj.rang;
                li.textContent = obj.name;
                (opt ? opt.list : itemLists[index]).append(li);
            })
            if ((opt ? opt.list : itemLists[index]).children.length == 0) {
                const li = document.createElement("li")
                li.textContent = "Ничего не найдено";
                (opt ? opt.list : itemLists[index]).append(li)
            }
        })
        
    }

    const sortList = (input) => {
        if (input.value.trim() == "") {
            generate()
        }
        var res = []
        const currentList = itemLists[comboBoxesI[0] == active ? 0 : 1]
        const type = Array.from(currentList.classList).includes("armor") ? "armor" : "weapons"
        data[type].forEach((obj, index) => {
            if (obj.name.toLowerCase().includes(input.value.toLowerCase().trim()) || obj.name.toLowerCase().includes(reverseText(input.value.toLowerCase()).trim())) res.push({name:obj.name, rang:obj.rang})
        })
        res = {data: res, list: currentList}
        generate(res)
    }

    const resetForm = () => {
        comboBoxesI[0].classList.remove("light");comboBoxesI[1].classList.remove("light");
        comboBoxesI[0].placeholder = "Выберите из списка";comboBoxesI[1].placeholder = "Выберите из списка";
        for (const input of inputs) {
            if (input.className != "combobox-input") {
                input.value = ""
            }
        }
        FORM.weapons = [];
        FORM.armor = [];
        FORM.inputs = [];
        level = 1
        reload()
    }

    const error = (focusElement) => {
        const currentBlock = focusElement.closest(".block");
        if (!Array.from(currentBlock.closest(".selector").classList).includes("error")) {
            const warn = document.createElement("h2");
            warn.className = "description red";
            var type;
            if (level == 2) {type = focusElement.closest(".combobox").classList[0] == "weapon-list" ? "оружие" : "броню"}
            warn.textContent = level == 2 ? "! Добавьте хотябы 1 " + type :  "! Это обязательный вопрос."
            currentBlock.closest(".selector").classList.add("error")
            currentBlock.prepend(warn)
        }
        focusElement.focus()
    }

    //event
    beforeBtn.onclick = () => {
        if (level > 1) {
            level--;reload()
        }
    }

    nextBtn.onclick = () => {
        const a = []
        const firstElem = textInputs.level.join("").indexOf(level.toString())
        const elemsCount = textInputs.level.join("").lastIndexOf(level.toString())
        if (level != 2) {
            for (let i = 0; i <= elemsCount-firstElem; i++) {
                a.push(textInputs.elements[i+firstElem].value.trim() != "")
            }
            const focusElement = textInputs.elements[firstElem + a.indexOf(false)]
            if (a.indexOf(false) == -1) {
                if (role == "next") {
                    if (level-1 < maxLevels) {
                        level++;reload();
                    } 
                } else {
                    const user = { //parse FORM
                        "weapons": FORM.weapons,
                        "armor": FORM.armor,
                        "namePers":FORM.inputs[0].value,
                        "nameDS":FORM.inputs[1].value,
                        "name":FORM.inputs[2].value,
                        "hp":FORM.inputs[3].value,
                        "bulletRes":FORM.inputs[4].value,
                        "powerRegen":FORM.inputs[5].value,
                        "speed":FORM.inputs[6].value,
                        "party": "",
                    }
                    level++;
                    localStorage.setItem("cockie", true)
                    document.querySelector(".footer").classList.add("hidden");
                    fetch('/src/users', {
                        "method":"POST",
                        "body": JSON.stringify(user),
                        "headers": {"Content-type":"Application/json; charset=UTF-8"}
                    }).then(data=>data.text()).then(data=>console.log(data))
                }
                
            } else {
                error(focusElement)
            }
        } else {
            if (FORM.weapons.length > 0) {
                if (FORM.armor.length > 0) {
                    level++;reload();
                } else {
                    error(comboBoxesI[1])
                }
            } else {
                error(comboBoxesI[0])
            }
        }
    }

    window.onclick = (e) => {
        if (!e.target.closest(".combobox")) {
            itemListBoxes[0].scrollTo(0, 0);itemListBoxes[1].scrollTo(0, 0);
            active = false;
            comboBoxesI[0].value = "";comboBoxesI[1].value = "";
            reload();
        }
    }

    textInputs.elements.forEach(input => {
        input.addEventListener("input", () => {
            if (Array.from(input.closest(".selector").classList).includes("error")) {
                input.closest(".selector").classList.remove("error");
                input.closest(".block").children[0].remove()
            }
            if (input.value.toString().length > 24) input.value = input.value.toString().slice(0, 24);
        })
    })

    comboBoxesI.forEach(comboBox => {
        comboBox.onclick = () => {
            active = comboBox;
            comboBox.value = "";reload();generate()
        }
        comboBox.oninput = () => sortList(comboBox)
    })

    itemLists.forEach(itemList=> {
        itemList.onclick = (e) => {
            if (e.target != itemListBoxes) {
                active.value = "";
                active.placeholder = e.target.textContent
                active.classList.add("light"); active.dataset["rang"] = e.target.dataset["rang"]
                active = false;reload()
            }
        }
    });

    [addWeaponBtn, addArmorBtn].forEach((elem, index) => {
        elem.onclick = () => {
            if (!Array.from(elem.classList).includes("disabled")) {
                if (Array.from(elem.closest(".selector").classList).includes("error")) {
                    elem.closest(".selector").classList.remove("error")
                    elem.closest(".block").children[0].remove()
                }
                (index == 0 ? FORM.weapons : FORM.armor).push({name:comboBoxesI[index].placeholder, mod: upgradeInputs[index].value});reload();
                upgradeInputs[index].value = ""
                comboBoxesI[index].placeholder = "Выберите из списка"
                comboBoxesI[index].classList.remove("light")
                genCart(index)
                reload()
            }
        }
    })
    restartBtn.onclick = () => confirm("Уверены?") ? resetForm() : null;
    upgradeInputs.forEach(input => input.oninput = () => reload());

    reload()
</script>
</html>